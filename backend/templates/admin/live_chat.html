{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Live Chat{% endblock %}

{% block content %}
<div id="admin-chat-app" class="flex gap-4 h-[80vh]">

  <!-- Rooms List -->
  <div class="w-1/4 border-r p-2 overflow-y-auto rounded-lg bg-white shadow">
    <h2 class="text-xl font-bold mb-2">Chat Rooms</h2>
    <ul>
      {% for room in rooms %}
        <li class="p-2 cursor-pointer hover:bg-purple-100 rounded room-item" data-room="{{ room.room_name }}">
          {{ room.user_name }} ({{ room.room_name }})
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat Box -->
  <div class="flex-1 flex flex-col bg-gray-50 rounded-lg shadow">
    <div id="chat-header" class="p-3 bg-purple-600 text-white font-bold text-lg rounded-t-lg">
      Select a chat room
    </div>
    <div id="chat-box" class="flex-1 p-3 overflow-y-auto space-y-2 scroll-smooth"></div>
    <div class="p-3 flex gap-2 border-t bg-white rounded-b-lg">
      <input type="text" id="admin-message" placeholder="Type a message..." class="flex-1 border rounded-md p-2 focus:ring-2 focus:ring-purple-500"/>
      <button id="send-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition">Send</button>
    </div>
  </div>
</div>

<!-- Include Framer Motion CDN -->
<script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

<script>
const chatBox = document.getElementById("chat-box");
const messageInput = document.getElementById("admin-message");
const sendBtn = document.getElementById("send-btn");
const chatHeader = document.getElementById("chat-header");

let socket = null;
let currentRoom = null;

// Auto scroll
function scrollBottom() {
  chatBox.scrollTop = chatBox.scrollHeight;
}

// Animate message using Framer Motion
function addMessage(msg, sender, user_name=null) {
  const div = document.createElement("div");
  div.innerHTML = `<strong>${sender==="user"?user_name:"Admin"}: </strong>${msg}<span class="text-xs text-gray-500 ml-2">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
  div.className = `p-2 rounded-lg max-w-[70%] break-words shadow transition-all duration-300 
                    ${sender==="user"?"bg-blue-500 text-white ml-auto animate-fade-in":"bg-gray-300 text-black mr-auto animate-fade-in"}`;
  chatBox.appendChild(div);
  scrollBottom();
}

// Room selection
document.querySelectorAll(".room-item").forEach(item => {
  item.addEventListener("click", () => {
    const room = item.dataset.room;
    currentRoom = room;
    chatBox.innerHTML = "";
    chatHeader.innerText = `Chat: ${room}`;

    // Close previous socket
    if (socket) socket.close();

    socket = new WebSocket(`ws://${window.location.host}/ws/chat/${room}/`);
    socket.onopen = () => console.log("Connected to room", room);

    socket.onmessage = e => {
      const data = JSON.parse(e.data);
      addMessage(data.message, data.sender, data.user_name || "Guest");
    };

    socket.onclose = () => console.log("Disconnected from room", room);
  });
});

// Send message
function sendMessage() {
  const msg = messageInput.value.trim();
  if (!msg || !currentRoom || !socket) return;
  socket.send(JSON.stringify({message: msg, sender:"admin"}));
  addMessage(msg, "admin");
  messageInput.value = "";
}
sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });
</script>

<style>
@keyframes fade-in {
  0% {opacity:0; transform: translateY(10px);}
  100% {opacity:1; transform: translateY(0);}
}
.animate-fade-in {
  animation: fade-in 0.3s ease forwards;
}
</style>
{% endblock %}
